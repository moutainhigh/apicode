<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ycandyz.master.dao.mall.MallHomeItemDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ycandyz.master.entities.mall.MallItem">
        <id column="id" property="id" />
        <result column="shop_no" property="shopNo" />
        <result column="category_no" property="categoryNo" />
        <result column="item_no" property="itemNo" />
        <result column="item_name" property="itemName" />
        <result column="item_text" property="itemText" />
        <result column="item_cover" property="itemCover" />
        <result column="banners" property="banners" />
        <result column="base_sales" property="baseSales" />
        <result column="real_sales" property="realSales" />
        <result column="sort_value" property="sortValue" />
        <result column="share_descr" property="shareDescr" />
        <result column="share_img" property="shareImg" />
        <result column="price" property="price" />
        <result column="lowest_sale_price" property="lowestSalePrice" />
        <result column="highest_sale_price" property="highestSalePrice" />
        <result column="stock" property="stock" />
        <result column="frozen_stock" property="frozenStock" />
        <result column="sub_stock_method" property="subStockMethod" />
        <result column="goods_no" property="goodsNo" />
        <result column="deliver_method" property="deliverMethod" />
        <result column="status" property="status" />
        <result column="is_unify_shipping" property="isUnifyShipping" />
        <result column="shipping_no" property="shippingNo" />
        <result column="unify_shipping" property="unifyShipping" />
        <result column="initial_purchases" property="initialPurchases" />
        <result column="limit_cycle_type" property="limitCycleType" />
        <result column="limit_skus" property="limitSkus" />
        <result column="limit_orders" property="limitOrders" />
        <result column="qr_code_url" property="qrCodeUrl" />
        <result column="created_time" property="createdTime" />
        <result column="updated_time" property="updatedTime" />
        <result column="is_enable_share" property="isEnableShare" />
        <result column="share_method" property="shareMethod" />
        <result column="share_rate" property="shareRate" />
        <result column="share_amount" property="shareAmount" />
        <result column="visits" property="visits" />
        <result column="is_updated_share" property="isUpdatedShare" />
        <result column="share_second_method" property="shareSecondMethod" />
        <result column="share_second_level_method" property="shareSecondLevelMethod" />
        <result column="share_second_rate" property="shareSecondRate" />
        <result column="share_second_amount" property="shareSecondAmount" />
        <result column="share_second_level_rate" property="shareSecondLevelRate" />
        <result column="share_second_level_amount" property="shareSecondLevelAmount" />
        <result column="share_third_method" property="shareThirdMethod" />
        <result column="share_third_level_method" property="shareThirdLevelMethod" />
        <result column="share_third_rate" property="shareThirdRate" />
        <result column="share_third_amount" property="shareThirdAmount" />
        <result column="share_third_level_rate" property="shareThirdLevelRate" />
        <result column="share_third_level_amount" property="shareThirdLevelAmount" />
        <result column="delivery_type" property="deliveryType" />
        <result column="pickup_address_ids" property="pickupAddressIds" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, shop_no, category_no, item_no, item_name, item_text, item_cover, banners, base_sales, real_sales, sort_value, share_descr, share_img, price, lowest_sale_price, highest_sale_price, stock, frozen_stock, sub_stock_method, goods_no, deliver_method, status, is_unify_shipping, shipping_no, unify_shipping, initial_purchases, limit_cycle_type, limit_skus, limit_orders, qr_code_url, created_time, updated_time, is_enable_share, share_method, share_rate, share_amount, visits, is_updated_share, share_second_method, share_second_level_method, share_second_rate, share_second_amount, share_second_level_rate, share_second_level_amount, share_third_method, share_third_level_method, share_third_rate, share_third_amount, share_third_level_rate, share_third_level_amount, delivery_type
    </sql>

    <sql id="Home_Column_List">
        t.id, t.item_no, t.item_name, t.status,t.item_cover, t.price ,t.lowest_sale_price,t.base_sales,t.real_sales
    </sql>

    <select id="selectMallItemPage" resultType="com.ycandyz.master.domain.response.mall.MallItemResp">
        SELECT <include refid="Home_Column_List"/>
        FROM mall_item t
        WHERE 1=1
        AND t.status = 10
        <if test="query.itemName != null"> and t.item_name like CONCAT('%',#{query.itemName},'%') </if>
        <if test="query.shopNo != null and query.shopNo != ''"> and t.shop_no = #{query.shopNo} </if>
    </select>
    
    <select id="selectItemSku" resultType="com.ycandyz.master.dto.mall.MallItemDTO">
        SELECT i.id,i.item_no,i.item_name,s.sku_no,i.`status`,i.stock,i.initial_purchases,i.limit_cycle_type,i.limit_skus,i.limit_orders,s.stock AS sku_stock
        FROM `mall_item` i LEFT JOIN `mall_sku` s ON i.item_no = s.item_no
        <where>
            s.sku_no in <foreach  item="item" collection="skuNos" index="index"  open="(" separator="," close=")">#{item}</foreach>
        </where>
    </select>


    <update id="updateMallSkuByItemNo" >
        update mall_item set stock = stock + #{stock}
        <where>
            item_no = #{itemNo}
        </where>
    </update>

    <update id="updateBuyNumByItemNo" >
        update mall_item set real_sales = real_sales + 1
        <where>
            item_no = #{itemNo}
        </where>
    </update>


</mapper>
