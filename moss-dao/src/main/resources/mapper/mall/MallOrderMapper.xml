<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ycandyz.master.dao.mall.MallOrderDao">

    <select id="getTrendMallOrderPage" parameterType="com.ycandyz.master.domain.query.mall.MallOrderQuery" resultType="com.ycandyz.master.dto.mall.MallOrderDTO">
        SELECT
            mo.id as id,
            cart.order_sn as cartOrderSn,
            mo.order_no as orderNo,
            group_concat(modetail.item_name) as	itemName,
            modetail.goods_no as goodsNo,
            modetail.quantity as quantity,
            mo.all_money as allMoney,
            mo.pay_type as payType,
            mo.`status` as status,
            mo.after_sales_status as afterSalesStatus,
            concat(u.`name`,' ',u.phone) as payuser,
            concat(ship.receiver,' ',ship.receiver_phone) as receiverName,
            ship.receiver_address as receiverAddress,
            mo.order_at as orderAt,
            cart.payment_time as paymentTime,
            mo.receive_at as receiveAt
        FROM
            mall_cart_order cart
            LEFT JOIN mall_order mo ON cart.id = mo.cart_order_id
            LEFT JOIN mall_order_detail modetail ON mo.order_no=modetail.order_no
            LEFT JOIN user u ON mo.user_id=u.id
            LEFT JOIN mall_shop_shipping ship ON ship.order_no=mo.order_no
            <if test="p.socialPartner != null and p.socialPartner != ''">
                LEFT JOIN (select modetail.order_no FROM mall_order_detail modetail LEFT JOIN user u ON modetail.share_user_id=u.id WHERE u.`name` like concat('%',#{p.socialPartner},'%') OR u.phone like concat('%',#{p.socialPartner},'%')) a ON mo.order_no=a.order_no /**合伙人*/
            </if>
        WHERE
            mo.shop_no=#{p.shopNo} and mo.is_del=0
            <if test="p.orderNo != null and p.orderNo != ''">
                and
                mo.order_no  like concat('%',#{p.orderNo},'%')	/**订单编号*/
            </if>
            <if test="p.mallName != null and p.mallName != ''">
                and
                (modetail.item_no like concat('%',#{p.mallName},'%') OR modetail.item_name like concat('%',#{p.mallName},'%')) /**商品名称或者编号*/
            </if>
            <if test="p.userMes != null and p.userMes != ''">
                and
                (u.`name` like concat('%',#{p.userMes},'%') OR u.phone like concat('%',#{p.userMes},'%'))	/**购买人名称或者手机号*/
            </if>
            <if test="p.consignor != null and p.consignor != ''">
                and
                (ship.receiver like concat('%',#{p.consignor},'%') OR u.phone like concat('%',#{p.consignor},'%'))	/**收货人名称或者手机号*/
            </if>
            <if test="p.deliverType != null and p.deliverType != ''">
                and
                mo.deliver_type=#{p.deliverType}	/**发货方式:1-配送 2-自提*/
            </if>
            <if test="p.distribution != null">
                and
                <if test="p.distribution==0">modetail.share_level_type=#{p.distribution} /**0没有分销，大于0有分销*/</if>
                <if test="p.distribution==1">modetail.share_level_type&gt;0 /**0没有分销，大于0有分销*/</if>
            </if>
            <if test="p.orderAtForm != null">
                and
                from_unixtime(mo.order_at, '%Y-%m-%d %H:%i:%S') &gt;= #{p.orderAtForm} /**下单时间*/
            </if>
            <if test="p.orderAtTo != null">
                and
                from_unixtime(mo.order_at, '%Y-%m-%d %H:%i:%S') &lt;= #{p.orderAtTo} /**下单时间*/
            </if>
            <if test="p.payedAtForm != null">
                and
                cart.payment_time &gt;= #{p.payedAtForm}	/**支付时间*/
            </if>
            <if test="p.payedAtTo != null">
                and
                cart.payment_time &lt;= #{p.payedAtTo}	/**支付时间*/
            </if>
            <if test="p.receiveAtForm != null">
                and
                from_unixtime(mo.receive_at, '%Y-%m-%d %H:%i:%S') &gt;= #{p.payedAtForm} /**收货时间*/
            </if>
            <if test="p.receiveAtTo != null">
                and
                from_unixtime(mo.receive_at, '%Y-%m-%d %H:%i:%S') &lt;= #{p.receiveAtTo} /**收货时间*/
            </if>
            <if test="p.afterSalesStatus != null">
                and
                <if test="p.afterSalesStatus==0">mo.after_sales_status=#{p.afterSalesStatus} /**售后状态：0-否  1-处理中  2-已完成*/</if>
                <if test="p.afterSalesStatus==1">mo.after_sales_status&gt;0 /**售后状态：0-否  1-处理中  2-已完成*/</if>
            </if>
            <if test="p.status != null">
                and mo.status=#{p.status}
            </if>
            group by mo.id
    </select>

    <select id="getTrendMallOrder" parameterType="com.ycandyz.master.domain.query.mall.MallOrderQuery" resultType="com.ycandyz.master.dto.mall.MallOrderDTO">
        SELECT
        mo.id as id,
        cart.order_sn as cartOrderSn,
        mo.order_no as orderNo,
        group_concat(modetail.item_name) as	itemName,
        /**货号*/
        mo.all_money as allMoney,
        mo.pay_type as payType,
        /**数量*/
        mo.`status` as status,
        mo.after_sales_status as afterSalesStatus,
        concat(u.`name`,' ',u.phone) as payuser,
        concat(ship.receiver,' ',ship.receiver_phone) as receiverName,
        ship.receiver_address as receiverAddress,
        mo.order_at as orderAt,
        cart.payment_time as paymentTime,
        mo.receive_at as receiveAt
        FROM
        mall_cart_order cart
        LEFT JOIN mall_order mo ON cart.id = mo.cart_order_id
        LEFT JOIN mall_order_detail modetail ON mo.order_no=modetail.order_no
        LEFT JOIN user u ON mo.user_id=u.id
        LEFT JOIN mall_shop_shipping ship ON ship.order_no=mo.order_no
        <if test="p.socialPartner != null and p.socialPartner != ''">
            LEFT JOIN (select modetail.order_no FROM mall_order_detail modetail LEFT JOIN user u ON modetail.share_user_id=u.id WHERE u.`name` like concat('%',#{p.socialPartner},'%') OR u.phone like concat('%',#{p.socialPartner},'%')) a ON mo.order_no=a.order_no /**合伙人*/
        </if>
        WHERE
        mo.shop_no=#{p.shopNo} and mo.is_del=0
        <if test="p.orderNo != null and p.orderNo != ''">
            and
            mo.order_no  like concat('%',#{p.orderNo},'%')	/**订单编号*/
        </if>
        <if test="p.mallName != null and p.mallName != ''">
            and
            (modetail.item_no like concat('%',#{p.mallName},'%') OR modetail.item_name like concat('%',#{p.mallName},'%')) /**商品名称或者编号*/
        </if>
        <if test="p.userMes != null and p.userMes != ''">
            and
            (u.`name` like concat('%',#{p.userMes},'%') OR u.phone like concat('%',#{p.userMes},'%'))	/**购买人名称或者手机号*/
        </if>
        <if test="p.consignor != null and p.consignor != ''">
            and
            (ship.receiver like concat('%',#{p.consignor},'%') OR u.phone like concat('%',#{p.consignor},'%'))	/**收货人名称或者手机号*/
        </if>
        <if test="p.deliverType != null">
            and
            mo.deliver_type=#{p.deliverType}	/**发货方式:1-配送 2-自提*/
        </if>
        <if test="p.distribution != null">
            and
            <if test="p.distribution==0">modetail.share_level_type=#{p.distribution} /**0没有分销，大于0有分销*/</if>
            <if test="p.distribution==1">modetail.share_level_type&gt;0 /**0没有分销，大于0有分销*/</if>
        </if>
        <if test="p.orderAtForm != null">
            and
            from_unixtime(mo.order_at, '%Y-%m-%d %H:%i:%S') &gt;= #{p.orderAtForm} /**下单时间*/
        </if>
        <if test="p.orderAtTo != null">
            and
            from_unixtime(mo.order_at, '%Y-%m-%d %H:%i:%S') &lt;= #{p.orderAtTo} /**下单时间*/
        </if>
        <if test="p.payedAtForm != null">
            and
            cart.payment_time &gt;= #{p.payedAtForm}	/**支付时间*/
        </if>
        <if test="p.payedAtTo != null">
            and
            cart.payment_time &lt;= #{p.payedAtTo}	/**支付时间*/
        </if>
        <if test="p.receiveAtForm != null">
            and
            from_unixtime(mo.receive_at, '%Y-%m-%d %H:%i:%S') &gt;= #{p.payedAtForm} /**收货时间*/
        </if>
        <if test="p.receiveAtTo != null">
            and
            from_unixtime(mo.receive_at, '%Y-%m-%d %H:%i:%S') &lt;= #{p.receiveAtTo} /**收货时间*/
        </if>
        <if test="p.afterSalesStatus != null">
            and
            <if test="p.afterSalesStatus==0">mo.after_sales_status=#{p.afterSalesStatus} /**售后状态：0-否  1-处理中  2-已完成*/</if>
            <if test="p.afterSalesStatus==1">mo.after_sales_status&gt;0 /**售后状态：0-否  1-处理中  2-已完成*/</if>
        </if>
        group by mo.id
    </select>

    <select id="queryOrderDetail" parameterType="java.lang.String" resultType="com.ycandyz.master.dto.mall.MallOrderDetailDTO">
        SELECT
            o.status as	status,
            o.sub_status as subStatus,
            o.payed_at as payedAt,
            o.order_at as orderAt,
            o.close_at as closeAt,
            modetail.item_name as itemName,
            modetail.item_cover as itemCover,
            modetail.goods_no as goodsNo,
            /**规格*/
            modetail.quantity as quantity,
            modetail.price as price,
            ship.shipping_money as shipMoney,
            o.all_money as allMoney
        FROM
            mall_order o LEFT JOIN mall_order_detail modetail ON o.order_no=modetail.order_no
            LEFT JOIN mall_shop_shipping ship ON o.order_no=ship.order_no
        WHERE
            o.order_no = #{orderNo}
            GROUP BY o.id
    </select>

    <select id="queryDetailByPickupNo" parameterType="java.lang.String" resultType="com.ycandyz.master.dto.mall.MallOrderDTO">
        select
            mo.id as id,
            mo.cart_order_id as cartOrderSn,
            mo.real_money as realMoney,
            mo.payed_at as payedAt,
            mo.buyer_remark as buyerRemark,
            mo.status as status,
            mo.sub_status as subStatus,
            mo.deliver_method as deliverMethod,
        from mall_order mo
        left join mall_order_detail modetail on mo.order_no=modetail.order_no
        where mo.shop_no=#{shopNo} and mo.pickup_no=#{pickupNo} and mo.is_del=0 and mo.deliver_type=2 and mo.status=30 and mo.sub_status=3010
        group by mo.id
    </select>

    <select id="queryDetailByPickupNo" parameterType="java.lang.String" resultType="com.ycandyz.master.dto.mall.MallOrderDTO">
        select
            mo.id as id,
            mo.order_no as orderNo,
            mo.cart_order_id as cartOrderSn,
            mo.real_money as realMoney,
            mo.payed_at as payedAt,
            mo.buyer_remark as buyerRemark,
            mo.status as status,
            mo.sub_status as subStatus,
            mo.deliver_method as deliverMethod,
            ship.receiver as receiverName,
            ship.receiver_phone as receiverPhone,
            mo.total_money as totalMoney,
            mo.buyer_remark as buyerRemark,
            mo.order_at as orderAt,
            mo.pay_type as payType,
            mo.trade_no as tradeNo,
            mo.send_at as sendAt,
            mo.receive_at as receiveAt,
            mo.cancel_at as cancelAt,
            mo.cancel_reason as cancelReason,
            modetail.order_detail_no as orderDetailNo,
            modetail.item_no as itemNo,
            modetail.goods_no as goodsNo
        from mall_order mo
        left join mall_order_detail modetail on mo.order_no=modetail.order_no
        left join mall_shop_shipping ship on mo.order_no=ship.order_no
        where mo.order_no=#{orderNo} and mo.pickup_no=#{pickupNo} and mo.is_del=0 and mo.deliver_type=2 and mo.status=30 and mo.sub_status=3010
        group by mo.id
    </select>
</mapper>